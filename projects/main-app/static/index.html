<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FamilyCam Control Room</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-1: #f4fbf7;
        --bg-2: #f5f8ff;
        --ink: #16333a;
        --muted: #5e7380;
        --line: #d2dde4;
        --panel: rgba(255, 255, 255, 0.88);
        --good: #13a46f;
        --warn: #ee9b00;
        --danger: #cf3f3f;
        --chip: #0c1f29;
        --soft-shadow: 0 18px 38px rgba(18, 52, 66, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Sora", sans-serif;
        color: var(--ink);
        min-height: 100vh;
        background: radial-gradient(circle at 8% 14%, #dbfff0 0%, transparent 36%),
          radial-gradient(circle at 86% 18%, #dbe8ff 0%, transparent 38%),
          linear-gradient(145deg, var(--bg-1), var(--bg-2));
        padding: 16px;
      }

      .shell {
        height: calc(100vh - 32px);
        max-height: 940px;
        border: 1px solid rgba(110, 135, 150, 0.32);
        border-radius: 24px;
        background: var(--panel);
        backdrop-filter: blur(4px);
        box-shadow: var(--soft-shadow);
        padding: 16px;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 12px;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .title-wrap {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-dot {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        background: linear-gradient(45deg, #26c485, #0fa0dd);
        box-shadow: 0 0 0 8px rgba(31, 177, 132, 0.18);
        animation: pulse 2s infinite;
      }

      .topbar h1 {
        margin: 0;
        font-size: 1.18rem;
        letter-spacing: 0.02em;
      }

      .subtitle {
        margin: 2px 0 0;
        font-size: 0.8rem;
        color: var(--muted);
      }

      .status-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-label {
        font-size: 0.75rem;
        color: var(--muted);
      }

      #status-chip {
        font-size: 0.79rem;
        font-weight: 600;
        padding: 7px 12px;
        border-radius: 999px;
        background: var(--chip);
        color: #eef7ff;
      }

      .layout {
        min-height: 0;
        display: grid;
        grid-template-columns: 1.65fr 1fr;
        gap: 12px;
      }

      .panel {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.82);
        min-height: 0;
      }

      .feed-panel {
        display: grid;
        grid-template-rows: auto 1fr;
        overflow: hidden;
      }

      .feed-head {
        border-bottom: 1px solid var(--line);
        padding: 12px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
      }

      .feed-head strong {
        font-size: 0.93rem;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      button {
        border: 0;
        border-radius: 12px;
        font-family: "Sora", sans-serif;
        padding: 8px 11px;
        font-size: 0.79rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, filter 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        filter: brightness(1.03);
      }

      .btn-start { background: #19bf7f; color: #05251c; }
      .btn-stop { background: #ffca2f; color: #302100; }
      .btn-snapshot { background: #c7deff; color: #0f2d4f; }
      .btn-panic { background: #ffd0d0; color: #5a1212; }
      .btn-muted { background: #eaf3f8; color: #234453; }
      .btn-primary { background: #bee8ff; color: #073c5b; }

      .feed-stage {
        position: relative;
        min-height: 0;
        padding: 12px;
      }

      #live {
        width: 100%;
        height: 100%;
        min-height: 320px;
        max-height: 100%;
        border-radius: 14px;
        object-fit: cover;
        background: linear-gradient(160deg, #06131a, #0f252d);
        border: 1px solid #244353;
      }

      .snapshot-tile {
        position: absolute;
        right: 24px;
        bottom: 24px;
        width: 210px;
        background: rgba(10, 31, 43, 0.88);
        border: 1px solid rgba(120, 180, 210, 0.35);
        border-radius: 12px;
        padding: 8px;
      }

      .snapshot-title {
        color: #cde6ff;
        font-size: 0.7rem;
        margin-bottom: 6px;
      }

      #snapshot {
        width: 100%;
        aspect-ratio: 16 / 10;
        border-radius: 8px;
        object-fit: cover;
        background: #001018;
      }

      .side-panel {
        display: grid;
        grid-template-rows: auto auto 1fr;
        gap: 10px;
        padding: 10px;
      }

      .card {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px;
        background: #ffffff;
      }

      .card h3 {
        margin: 0 0 8px;
        font-size: 0.82rem;
      }

      .field {
        display: grid;
        gap: 4px;
        margin-bottom: 8px;
      }

      .field label {
        font-size: 0.72rem;
        color: var(--muted);
      }

      .field input,
      .field select {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 9px;
        height: 34px;
        padding: 0 9px;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.78rem;
        color: #183847;
        background: #f8fcff;
      }

      .mini-note {
        margin: 0;
        font-size: 0.72rem;
        min-height: 1.2em;
      }

      .note-ok { color: #1a8756; }
      .note-warn { color: #9e6e00; }
      .note-bad { color: #bd2f2f; }

      #camera-list {
        margin: 0;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #f6fbff;
        padding: 8px;
        font-family: "IBM Plex Mono", monospace;
        font-size: 0.73rem;
        white-space: pre-wrap;
        overflow: auto;
        max-height: 100%;
      }

      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.18); }
        100% { transform: scale(1); }
      }

      @media (max-width: 1080px) {
        body {
          overflow: auto;
          padding: 10px;
        }
        .shell {
          height: auto;
          max-height: none;
          min-height: calc(100vh - 20px);
        }
        .layout {
          grid-template-columns: 1fr;
        }
        .feed-stage {
          min-height: 300px;
        }
        .snapshot-tile {
          width: 160px;
          right: 18px;
          bottom: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="topbar">
        <div class="title-wrap">
          <span class="logo-dot"></span>
          <div>
            <h1>FamilyCam Control Room</h1>
            <p class="subtitle">On-demand home monitor, single-client mode</p>
          </div>
        </div>
        <div class="status-wrap">
          <span class="status-label">Status</span>
          <span id="status-chip">Login required</span>
        </div>
      </header>

      <div class="layout">
        <section class="panel feed-panel">
          <div class="feed-head">
            <strong>Live Feed</strong>
            <div class="controls">
              <button class="btn-start" onclick="startCamera()">Start</button>
              <button class="btn-stop" onclick="stopCamera()">Stop</button>
              <button class="btn-snapshot" onclick="takeSnapshot()">Snapshot</button>
              <button class="btn-panic" onclick="panicAlert()">Panic</button>
            </div>
          </div>
          <div class="feed-stage">
            <img id="live" alt="Live stream will appear after start" />
            <div class="snapshot-tile">
              <div class="snapshot-title">Last Snapshot</div>
              <img id="snapshot" alt="Snapshot preview" />
            </div>
          </div>
        </section>

        <aside class="panel side-panel">
          <div class="card">
            <h3>Access</h3>
            <div class="field">
              <label>Password</label>
              <input id="password" type="password" placeholder="Enter app password" />
            </div>
            <button class="btn-primary" onclick="login()">Login</button>
            <p id="login-result" class="mini-note"></p>
          </div>

          <div class="card">
            <h3>Camera Routing</h3>
            <div class="controls" style="margin-bottom:8px;">
              <button class="btn-muted" onclick="probeCameras()">Probe Cameras</button>
              <button class="btn-muted" onclick="setCameraDevice()">Set Runtime</button>
            </div>

            <div class="field">
              <label>Device</label>
              <select id="camera-device-select" onchange="onDeviceChange()">
                <option value="">Probe dulu</option>
              </select>
            </div>

            <div class="field" style="margin-bottom:0;">
              <label>Input Format</label>
              <select id="camera-format-select">
                <option value="mjpeg">mjpeg</option>
              </select>
            </div>
          </div>

          <div class="card" style="min-height:0; display:grid; grid-template-rows:auto 1fr; gap:8px;">
            <h3>Probe Result</h3>
            <pre id="camera-list">Belum diprobe.</pre>
          </div>
        </aside>
      </div>
    </div>

    <script>
      const probeState = { byDevice: {} };
      let statusTimer = null;
      let authenticated = false;

      function setMessage(text, mode = "warn") {
        const el = document.getElementById("login-result");
        el.textContent = text;
        el.className = "mini-note " + (mode === "ok" ? "note-ok" : mode === "bad" ? "note-bad" : "note-warn");
      }

      function setStatusChip(html, fallbackLabel) {
        const chip = document.getElementById("status-chip");
        if (html) {
          chip.innerHTML = html;
        } else if (fallbackLabel) {
          chip.textContent = fallbackLabel;
        }
      }

      async function refreshStatus() {
        const response = await fetch("/status");
        if (response.status === 401) {
          authenticated = false;
          setStatusChip("", "Login required");
          return;
        }
        if (!response.ok) {
          setStatusChip("", "Status unavailable");
          return;
        }
        const html = await response.text();
        setStatusChip(html);
      }

      function startStatusPolling() {
        if (statusTimer) {
          clearInterval(statusTimer);
        }
        statusTimer = setInterval(async () => {
          try {
            if (authenticated) {
              await refreshStatus();
            }
          } catch (_) {}
        }, 4000);
      }

      function normalizeFormatForFfmpeg(rawFormat) {
        const code = (rawFormat || "").toUpperCase();
        if (code === "MJPG") return "mjpeg";
        if (code === "YUYV") return "yuyv422";
        if (code === "H264") return "h264";
        if (code === "NV12") return "nv12";
        if (!code) return "mjpeg";
        return rawFormat.toLowerCase();
      }

      function renderFormatOptions(devicePath) {
        const formatSelect = document.getElementById("camera-format-select");
        const currentValue = formatSelect.value;
        const formats = (probeState.byDevice[devicePath]?.formats || []);
        const normalizedUnique = Array.from(new Set(formats.map((f) => normalizeFormatForFfmpeg(f))));
        const values = normalizedUnique.length ? normalizedUnique : ["mjpeg"];

        formatSelect.innerHTML = "";
        values.forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          formatSelect.appendChild(option);
        });

        if (currentValue && values.includes(currentValue)) {
          formatSelect.value = currentValue;
        }
      }

      function renderDeviceOptions() {
        const select = document.getElementById("camera-device-select");
        const currentValue = select.value;
        const devices = Object.keys(probeState.byDevice).sort();

        select.innerHTML = "";
        if (!devices.length) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "Tidak ada device";
          select.appendChild(option);
          renderFormatOptions("");
          return;
        }

        devices.forEach((devicePath) => {
          const option = document.createElement("option");
          option.value = devicePath;
          option.textContent = devicePath;
          select.appendChild(option);
        });

        select.value = devices.includes(currentValue) ? currentValue : devices[0];
        renderFormatOptions(select.value);
      }

      function onDeviceChange() {
        renderFormatOptions(document.getElementById("camera-device-select").value);
      }

      function startStream() {
        document.getElementById("live").src = "/stream?ts=" + Date.now();
      }

      function stopStream() {
        document.getElementById("live").src = "";
      }

      async function login() {
        const password = document.getElementById("password").value;
        const response = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "password=" + encodeURIComponent(password)
        });

        if (!response.ok) {
          authenticated = false;
          setMessage("Login gagal.", "bad");
          setStatusChip("", "Login required");
          return;
        }

        authenticated = true;
        setMessage("Login berhasil.", "ok");
        await refreshStatus();
      }

      async function startCamera() {
        const response = await fetch("/start", { method: "POST" });
        if (!response.ok) {
          setMessage("Start gagal. Pastikan sudah login.", "bad");
          return;
        }
        const html = await response.text();
        setStatusChip(html);
        startStream();
      }

      async function stopCamera() {
        const response = await fetch("/stop", { method: "POST" });
        if (!response.ok) {
          setMessage("Stop gagal. Pastikan sudah login.", "bad");
          return;
        }
        const html = await response.text();
        setStatusChip(html);
        stopStream();
      }

      async function takeSnapshot() {
        const response = await fetch("/snapshot?ts=" + Date.now());
        if (!response.ok) {
          setMessage("Snapshot gagal: " + await response.text(), "bad");
          return;
        }
        const blob = await response.blob();
        document.getElementById("snapshot").src = URL.createObjectURL(blob);
      }

      async function panicAlert() {
        const response = await fetch("/panic", { method: "POST" });
        if (!response.ok) {
          setMessage("Panic gagal. Login dulu.", "bad");
          return;
        }
        setMessage("Panic event terkirim.", "warn");
      }

      async function probeCameras() {
        const target = document.getElementById("camera-list");
        target.textContent = "Memproses...";
        probeState.byDevice = {};

        const response = await fetch("/cameras");
        if (!response.ok) {
          target.textContent = "Gagal probe. Pastikan sudah login.";
          return;
        }

        const cameras = await response.json();
        if (!Array.isArray(cameras) || !cameras.length) {
          target.textContent = "Tidak ada kamera terdeteksi.";
          renderDeviceOptions();
          return;
        }

        const lines = [];
        for (const camera of cameras) {
          lines.push("â€¢ " + camera.name);
          for (const device of (camera.devices || [])) {
            const fmts = (device.formats || []).length ? device.formats.join(", ") : "-";
            lines.push("  - " + device.path + " | formats: " + fmts);

            if (!probeState.byDevice[device.path]) {
              probeState.byDevice[device.path] = { formats: [] };
            }
            const merged = new Set([
              ...probeState.byDevice[device.path].formats,
              ...(device.formats || [])
            ]);
            probeState.byDevice[device.path].formats = Array.from(merged);
          }
        }

        target.textContent = lines.join("\n");
        renderDeviceOptions();
      }

      async function setCameraDevice() {
        const device = document.getElementById("camera-device-select").value.trim();
        const inputFormat = document.getElementById("camera-format-select").value.trim();

        const response = await fetch("/camera/select", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ device, input_format: inputFormat })
        });

        if (!response.ok) {
          setMessage("Set camera gagal: " + await response.text(), "bad");
          return;
        }

        const body = await response.json();
        setMessage("Camera runtime: " + body.device + " (" + body.input_format + ")", "ok");
      }

      document.getElementById("password").addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          login();
        }
      });

      startStatusPolling();
    </script>
  </body>
</html>
